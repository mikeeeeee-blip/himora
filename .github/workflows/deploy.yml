name: Deploy to Production

on:
  push:
    branches:
      - master
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., v1.0.0)'
        required: false
        type: string

env:
  NODE_VERSION: '18.x'
  SERVER_HOST: ec2-13-50-107-204.eu-north-1.compute.amazonaws.com
  SERVER_USER: ec2-user
  DEPLOY_PATH: /home/ec2-user/ninex-group
  CLIENT_DEPLOY_PATH: /var/www/html/ninex-group

jobs:
  bump-version:
    name: Bump Version
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/')
    outputs:
      new_version: ${{ steps.bump.outputs.version }}
      version_tag: ${{ steps.bump.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Bump version
        id: bump
        run: |
          cd ${{ github.workspace }}
          chmod +x scripts/bump-version.sh
          ./scripts/bump-version.sh
          NEW_VERSION=$(node -p "require('./server/package.json').version")
          VERSION_TAG="v${NEW_VERSION}"
          echo "version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${VERSION_TAG}" >> $GITHUB_OUTPUT
          echo "Bumped to version: ${NEW_VERSION}"
          echo "Tag: ${VERSION_TAG}"

      - name: Commit version bump
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add server/package.json client/package.json CHANGELOG.md
          git commit -m "chore: bump version to ${{ steps.bump.outputs.version }}" || exit 0
          git push origin master

      - name: Create tag
        run: |
          git tag -a "${{ steps.bump.outputs.tag }}" -m "Release ${{ steps.bump.outputs.tag }}"
          git push origin "${{ steps.bump.outputs.tag }}"

  deploy-server:
    name: Deploy Server
    needs: bump-version
    runs-on: ubuntu-latest
    if: always() && (needs.bump-version.result == 'success' || startsWith(github.ref, 'refs/tags/'))
    environment:
      name: production
      url: https://api.himora.art
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          SSH_KEY: ~/.ssh/deploy_key
        run: |
          ssh -i $SSH_KEY -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            set -e
            cd ${{ env.DEPLOY_PATH }}
            
            # Backup current deployment
            if [ -d "current" ]; then
              echo "Creating backup..."
              BACKUP_DIR="backups/$(date +%Y%m%d_%H%M%S)"
              mkdir -p backups
              cp -r current $BACKUP_DIR
              echo "Backup created: $BACKUP_DIR"
            fi
            
            # Pull latest code
            echo "Pulling latest code..."
            git fetch --all --tags
            git checkout master
            git pull origin master
            
            # Install dependencies
            echo "Installing server dependencies..."
            cd server
            npm ci --production
            
            # Restart PM2 process
            echo "Restarting server..."
            pm2 restart ninex-group-api || pm2 start server/index.js --name ninex-group-api
            
            # Save PM2 configuration
            pm2 save
            
            echo "Server deployment completed successfully!"
          ENDSSH

      - name: Health check
        run: |
          sleep 10
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            curl -f http://localhost:5001/api/health || exit 1
            echo "Health check passed!"
          ENDSSH

  deploy-client:
    name: Deploy Client
    needs: deploy-server
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build client
        run: |
          cd client
          npm ci
          npm run build

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy client build
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            set -e
            mkdir -p ${{ env.CLIENT_DEPLOY_PATH }}
            
            # Backup current build
            if [ -d "${{ env.CLIENT_DEPLOY_PATH }}/dist" ]; then
              BACKUP_DIR="${{ env.CLIENT_DEPLOY_PATH }}/backups/$(date +%Y%m%d_%H%M%S)"
              mkdir -p ${{ env.CLIENT_DEPLOY_PATH }}/backups
              cp -r ${{ env.CLIENT_DEPLOY_PATH }}/dist $BACKUP_DIR
              echo "Client backup created: $BACKUP_DIR"
            fi
          ENDSSH

      - name: Copy build files
        run: |
          scp -i ~/.ssh/deploy_key -r client/dist/* ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:${{ env.CLIENT_DEPLOY_PATH }}/

  create-release:
    name: Create GitHub Release
    needs: [deploy-server, deploy-client]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            VERSION=$(node -p "require('./server/package.json').version")
            echo "version=v${VERSION}" >> $GITHUB_OUTPUT
          fi

      - name: Generate release notes
        id: notes
        run: |
          VERSION=${{ steps.version.outputs.version }}
          CHANGELOG_SECTION=$(awk "/## \[${VERSION}\]/,/## \[/ {if (/## \[/ && !/## \[${VERSION}\]/) exit; print}" CHANGELOG.md)
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG_SECTION" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version }}
          release_name: Release ${{ steps.version.outputs.version }}
          body_path: /dev/stdin
          draft: false
          prerelease: false
        continue-on-error: true

  smoke-tests:
    name: Smoke Tests
    needs: [deploy-server, deploy-client]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."
          # Add your smoke test commands here
          # curl -f https://api.himora.art/api/health || exit 1
          echo "âœ… Smoke tests passed!"
